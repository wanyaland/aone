{% extends 'core/base.html' %}

{% block main %}
  <div class="blue-header-bg"></div>

  <div class="review-form-wrapper container">
    <div class="row">
      <div class="col-md-8 column-left">
        <div class="column-title">
          Write a Review
        </div>

        <div class="business-block-wrapper clearfix">
          <div class="business-photo">
            {% if business.banner_photo %}
              <img src="{{ business.banner_photo.url }}">
            {% else %}
              <img src="/static/africaone/static-images/no-logo.jpg">
            {% endif %}
          </div>

          <div class="business-details">
            <div class="business-name">
              {{ business.name|upper }}
            </div>

            <div class="business-info clearfix">
              <div class="business-info-left">
                <div class="business-rating">
                  <div class="rateit rating-stars" data-rateit-starwidth="17" data-rateit-starheight="14" data-rateit-value="{{ business.get_avg_rating }}" data-rateit-readonly="true">
                  </div>
                  <span>{{ business.get_no_reviews }} review{{ business.get_no_reviews|pluralize:".,s." }}</span>
                </div>
                
                <div class="business-address">
                  {{ business.address }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="your-review-block">
          <h3>Your Review</h3>

          <form class="add-review-form" action="{{action_url}}" method="post" enctype="multipart/form-data">
            {%csrf_token%}

            {% if form.errors %}
              <div class="form-errors">
                {% for field,error in form.errors.items %}
                  <div class="form-error-text">
                    {% if field != '__all__' %}{{ field }}: {% endif %}
                    {{ error|striptags }}
                    {{ message }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="stars-photo-block">
              <div class="rating-input">
                <div class="rateit rating-stars blue" data-rateit-resetable="false" data-rateit-step="1" data-rateit-starwidth="17" data-rateit-starheight="14" data-rateit-value="{{ form.rating.value|default_if_none:'0' }}"></div>
                <input type="hidden" name="rating" value="{{ form.rating.value|default_if_none:'' }}">
                <span>Choose rating</span>
              </div>
              <div class="photo-input">
                <div class="photo-icon"></div>
                <span>Add a photo</span>
                {{form.files}}
              </div>
            </div>

            <div class="stars-comment">
              Click stars to rate this restaurant
            </div>
            <div id="file-list"></div>

            <textarea id="new-review-area" name="review">{{ form.review.value|default_if_none:'' }}</textarea>

            <input type="submit" class="btn line-45" value="POST">
            <a href="{% url 'core:review_list' %}" class="btn grey-btn line-45">CANCEL</a>

            <div class="form-comment">
              Please Note that you can always edit or remove your reviews later.
            </div>
          </form>
        </div>
      </div>

      <div class="col-md-4 column-right">
        <div class="column-title">
          Other Reviews
        </div>

        {% if not reviews %}
          <div class="other-review-wrapper">
            No reviews for {{ business.name }}
          </div>
        {% endif %}

        {% for review in reviews %}
          {{tracking_hit_post}}
          <div class="other-review-wrapper">
            <div class="review-annotation-block">
              <div class="review-header clearfix">
                <div class="user-photo">
                  {% if review.customer.photo %}
                    <img src="{{review.customer.photo.url}}" class="img">
                  {% else %}
                    <img src="/static/africaone/static-images/empty-avatar.jpg">
                  {% endif %}
                </div>
                <div class="header-info">
                  <div class="user-name">
                    By {{review.customer|default_if_none:'Anonymous'}}
                  </div>

                  <div class="user-since">
                    Member since {{review.customer.user.date_joined|date:'M d, Y'}}
                  </div>

                  <div class="rateit rating-stars" data-rateit-starwidth="17" data-rateit-starheight="14" data-rateit-value="{{ review.rating.score|default_if_none:'0' }}" data-rateit-readonly="true"></div>
                  <div class="rating-block clearfix">
                    <div class="rating-description">
                      {{ review.rating.score|default_if_none:'0' }} out of 5 stars
                    </div>
                    <div class="date">
                      On {{review.create_date|date:'M d, Y'}}
                    </div>
                  </div>
                </div>
              </div>

              <div class="review-container">

                <div class="review-text">
                  <div class="short-text">
                    {{ review.review|truncatechars:280 }}
                    {% if review.review|length > 277 %}
                      <span class="read-more-link">Read more</span>
                    {% endif %}
                  </div>
                  <div class="full-text">
                    {{ review.review}}
                  </div>
                </div>
              </div>

              {% if review.businessphoto_set.all %}
                <div class="review-photos">
                  {% for review_photo in review.businessphoto_set.all %}
                    <a href="{{ review_photo.photo.url }}" data-lightbox="review-{{ review.id }}">
                      <img src="{{ review_photo.photo.url }}">
                    </a>
                  {% endfor %}
                </div>
              {% endif %}

            </div>
          </div>
        {% endfor %}

      </div>
    </div>
  </div>
    
{% endblock %}

{% block scripts %}
  <link href="/static/africaone/js/plugins/lightbox2/css/lightbox.min.css" rel="stylesheet">
  <script src="/static/africaone/js/plugins/lightbox2/js/lightbox.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      textAreaPlaceholderHandler();
      ratingHandler();
      fileNamesHandler();
      loadMoreHandler();
      initLightbox();
    });

    function textAreaPlaceholderHandler() {
      var area = $('#new-review-area');
      var placeholderText = 'Start your review here.\n\nYour review will help others find and learn about great local businesses. It will also support the local businesses.\n\nPlease don\'t review this business if you received anything for writing this review; or if you are in anyway connected to the owner or employees.';

      if (area.val() === '') {
        area.val(placeholderText);
        area.addClass('clear');
      }
        
      area.focus(function() {
        if($(this).val() === placeholderText) {
          $(this).val('');
          $(this).removeClass('clear');
        }
      });

      area.blur(function() {
        if($(this).val() === '') {
          $(this).val(placeholderText);
          $(this).addClass('clear');
        }    
      });

      $('.your-review-block form input[type="submit"]').click(function() {
        if (area.hasClass('clear')) {
          area.val('');
        }
      });
    }

    function ratingHandler() {
      $('.rating-stars').bind('rated', function(event, value) {
        $('input[name="rating"]').val(value);
      });
    }

    function fileNamesHandler() {
      $('#id_files').change(function() {
        var list = $('file-list');

        for (var x = 0; x < $(this)[0].files.length; x++) {
          var f = document.createElement('div');
          f.innerHTML = 'File ' + (x + 1) + ':  ' + $(this)[0].files[x].name;
          $('#file-list').append(f);
        }
      });
    }

    function loadMoreHandler() {
      $('.read-more-link').click(function() {
        textWrapper = $(this).parent().parent();
        textWrapper.children('.short-text').hide();
        textWrapper.children('.full-text').show();
      });
    }

    function initLightbox() {
      lightbox.option({
        'wrapAround': true
      })
    }
  </script>
{% endblock %}
